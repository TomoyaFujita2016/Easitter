import byDestroy as byD
import byGoodUser as byG
import tweepy
import twitterApiSetup as tas
import sys
api = tas.tweetSetup()
me = api.me()
args = sys.argv
FollowCnt = 0
FollowCntFromFriend= 0

tags = ["機械学習", "Androidアプリ", "Androidゲームアプリ", "ベンチャー", "強化学習", "ゲームアプリ開発","AndroidStudio", "AndroidApp", "AndroidDeveloper", "個人開発", "DeepLearning"]

def byFollow(api, friend_id, lowerFFRatio, upperHashRatio, lowerTPDRatio):
    user = api.get_user(friend_id)
    if(byG.byAlreadyFriend(api, friend_id)):
        print("[ " + user.name + " ] is already followed!")
        return False
    if(
        print("[ " + user.name + " ] is being analyzing!")
        byFFRatio = byG.byFFRatio(api, friend_id, lowerFFRatio)
        byBot = byG.byBot(api, friend_id)
        byCrazyHashTagUrl = byG.byCrazyHashTagUrl(api, friend_id, upperHashRatio)
        byOldMan = byG.byOldMan(api, friend_id)
        byTweetPerDay = byG.byTweetPerDay(api, friend_id, lowerTPDRatio)

    return ((byFFRatio) and not(byBot) and not(byCrazyHashTagUrl) and not(byOldMan) and (byTweetPerDay))
FollowCnt = 0
FollowCntFromFriend = 0
FollowLimit = 30

while True:
    print("Start Following!")
    try:
        for tag in tags:
            for tweet in api.search(q=tag ,count=5):
                try:
                    if(byFollow(api, tweet.user.id, 1.0, 0.25, 0.5)):
                        api.create_friendship(tweet.user.id, True)
                        print("Successed in following " + tweet.user.name)
                        FollowCnt += 1
                        if(FollowLimit <= (FollowCnt + FollowCntFromFriend)):
                            print("FollowLimit")
                            raise Exception
                except tweepy.error.TweepError:
                    print("ERROR: FAILED TO FOLLOW "+ tweet.user.name)
        MyFriends = byD.getFriendsIds(api, me.id)
        for myFriend in MyFriends:
            friends = byD.getFriendsIds(api, myFriend)
            for friend in friends:
                try:
                    name = api.get_user(friend)
                    if(byFollow(api, friend, 1.0, 0.25, 0.5)):
                        api.create_friendship(friend, True)
                        FollowCntFromFriend += 1
                        print("Successed in following " + name.name)
                        if(FollowLimit <= (FollowCnt + FollowCntFromFriend)):
                            print("FollowLimit")
                            raise Exception
                except tweepy.error.TweepError:
                    print("ERROR: FAILED TO FOLLOW "+ name.name)
    except (Exception, KeyboardInterrupt):
        print ("\nCnt: "+ str(FollowCnt)+ "\nCntFromFriend: "+str(FollowCntFromFriend)+"\nTotal: "+str(FollowCnt+FollowCntFromFriend))
        break
